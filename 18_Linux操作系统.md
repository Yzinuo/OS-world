# initramfs
OS会加载一个init进程后，控制权交给init进程。
操作系统就是文件对象+API  那么其实操作系统在初始化的时候不是所有的文件对象都准备好了，而是先打开一个小世界：initramfs  初始的文件系统

它仅仅包括：/bin/busybox  （包含了shell多种命令 ls等）， /dev/consle 终端，控制输入输出。

**启动的初级阶段**
- 加载必要的驱动程序，例如网卡
- 挂载必要的文件系统
- 将根文件系统和控制权移交给另一个程序，例如systemd

initramfs 的工作流程大致如下：

- 引导加载程序（Bootloader）：当计算机启动时，引导加载程序（如GRUB）首先加载Linux内核和initramfs。
内核初始化：内核被加载到内存后，它会首先挂载一个名为 rootfs 的文件系统，这实际上就是一个基于内存的 ramfs，内核不需要特殊的驱动就可以挂载它。

- 加载 initramfs：接下来，内核会解压缩 initramfs 中的内容到 rootfs 文件系统中。这些内容包括了驱动程序、工具和脚本，它们用于准备系统并挂载真正的根文件系统。

- 系统初始化：initramfs 中的 init 程序（或类似的脚本）开始执行。它会探测硬件设备、加载必要的驱动程序，并执行其他必要的初始化任务。
挂载根文件系统：一旦所有必要的驱动程序和配置都已就绪，init 程序会挂载真正的根文件系统。

- 切换根目录：最后，init 程序会使用 switch_root 命令切换到新的根文件系统，并执行 /sbin/init 程序，这通常是 systemd 或其他初始化系统。
释放内存：initramfs 的任务完成后，它占用的内存空间会被释放，因为它的内容已经不再需要了。

**为什么需要 initramfs？**

- 驱动程序加载：Linux内核本身并不包含所有可能需要的驱动程序。initramfs 提供了一种机制，可以在内核能够访问根文件系统之前加载这些驱动程序。
- 灵活性：initramfs 允许在启动过程中执行复杂的初始化脚本，例如设置网络、解密文件系统等。
  
- 兼容性：由于硬件配置的多样性，initramfs 可以包含特定于硬件的驱动程序，确保系统能够成功启动。
  
总的来说，initramfs 是Linux启动过程中的一个关键组件，它确保了系统能够正确地加载所有必要的驱动程序和服务，从而顺利地将控制权交给 init 进程。

# switch_root
## 理解挂载
挂载就是简单来说，挂载就是将一个存储设备（比如硬盘、U盘、CD-ROM等）接入到系统的文件目录树中的某个点上，这样你就可以通过这个目录点来访问和管理该存储设备上的文件和目录了

在Linux系统中，这个过程更加灵活。因为Linux只有一个根目录 /，所有的存储设备都需要挂载到这个根目录下的某个位置。例如，如果你有一个新的硬盘分区，比如 /dev/sdb1，你想要访问它，你需要先创建一个目录，比如 ~/Share，然后使用 mount 命令将它挂载到这个目录：

你访问 ~/Share 目录时，你实际上就是在访问 /dev/sdb1 分区上的文件。当你完成操作后，你可以使用 umount 命令来卸载这个存储设备

## 理解switch_root
使用过程：
- 初始时只有initramfs这个文件系统，此时我们可以把某个磁盘挂载在initramfs中的一个目录，其次使用swith_root，我们就可以把文件系统的root从initramfs换成这个挂载的磁盘。并释放不需要的空间。

此后找到对应的/sbin/init程序（systemd），开始执行。

## linux整个启动过程
Linux系统的启动过程可以分为以下几个主要步骤：

1. CPU重置：计算机开机后，CPU执行一个重置操作，开始从预设的内存地址读取指令执行。

2. 执行固件（BIOS/UEFI）：CPU首先执行的是固件（BIOS或UEFI）的代码。固件负责进行硬件自检（POST），然后根据设置的启动顺序找到启动设备1。
加载启动管理器（如GRUB）：固件从启动设备（通常是硬盘）加载启动管理器，启动管理器提供了选择不同操作系统或内核配置的界面。

3. 加载内核和initramfs：启动管理器加载Linux内核和initramfs到内存中。initramfs是一个临时的初始根文件系统，包含了启动所需的最基本的驱动和工具1。

4. 内核初始化：内核被加载后，它会初始化硬件设备、设置内存管理等，并挂载initramfs作为初始的根文件系统。

5. 运行initramfs中的init程序：initramfs中通常包含一个/init脚本或可执行程序，这是系统启动后运行的第一个用户空间程序。它负责加载必要的驱动程序，准备真正的根文件系统23。

6. 切换到真正的根文件系统：一旦真正的根文件系统准备好，/init程序会使用switch_root或类似的命令切换到这个根文件系统，并运行其上的/sbin/init程序（或其他指定的init系统，如systemd）。
系统进一步初始化：/sbin/init程序（或等效的init系统）接管后，会根据配置继续启动系统服务和用户进程，完成系统的启动过程。

## WSL1

在**WSL1**中，蒋老师的描述是准确的。WSL1不运行一个真正的Linux内核，而是通过一个兼容层来实现Linux系统调用的翻译，这个兼容层将Linux系统调用转换为Windows NT内核调用。所以，WSL1更像是一个高级的模拟环境，它模拟Linux环境并允许你在Windows中直接运行Linux二进制执行文件，但实际上背后是通过Windows内核来完成工作的。

## WSL2

而**WSL2**则采用了完全不同的方法。WSL2使用了一个真正的Linux内核，它运行在一个轻量级的虚拟机（VM）中。这意味着在WSL2中，你使用的是真正的Linux内核，而不是一个简单的模拟或兼容层。这提供了更高的性能，特别是在文件系统操作和Linux特有的功能上，同时也支持更多的Linux软件和工具。

## 关键区别

- **兼容性**：WSL2由于使用了真实的Linux内核，因此在兼容性方面表现更好，能够运行更多的Linux软件，包括Docker等需要特定内核支持的应用。
- **性能**：WSL2在文件系统性能上有显著提升，尤其是对于更复杂的文件系统操作。
- **资源隔离**：WSL2通过虚拟机来运行Linux内核，这提供了更好的资源隔离和安全性。

因此，如果你使用的是WSL2，那么你实际上是在使用一个真实的Linux内核。而如果是WSL1，那么的确，它更像是在模拟Linux环境。这两种模式都为Windows用户提供了在不离开Windows环境的情况下运行Linux应用程序的能力。
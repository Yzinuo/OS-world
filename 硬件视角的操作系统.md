# 计算机系统的状态机模型
## 内存映射
   
   
 内存映射I/O 在这种机制下,CPU将一部分物理内存地址空间保留给外部设备使用。每个设备会被分配一个内存地址范围,范围内的地址对应着该设备的寄存器。


 当CPU访问这些特殊的内存地址时,实际上就是在读写对应设备的寄存器。这种机制使得CPU可以像访问普通内存一样,通过load/store指令访问设备寄存器。

---
## 拓宽状态机状态

不仅仅包括内存，register的状态，还包括外界的物理状态。每个CPU的reset要求不一样。

- 操作系统管理和维护了系统的全部状态 操作系统需要追踪和管理系统的各种状态,包括CPU状态(寄存器值)、内存状态(内存内容)、进程状态(运行、阻塞等)、文件状态、外设状态等等。这些状态的组合构成了系统的"总状态"。


- 外设状态反映了外界物理世界的状态 外设如键盘、鼠标、磁盘、网卡等,是连接计算机内部与物理世界的桥梁。外设内部有一些寄存器,用于存储当前与物理世界交互的状态数据。 比如键盘输入了什么键、鼠标移动了多少、磁盘读写了什么数据、网卡收发了哪些数据包等,这些都反映了外部物理世界当
前的某个方面的状态。

- 操作系统通过设备映射获取外设状态 正如前面提到的,操作系统通过内存映射或I/O端口映射的机制,可以读写外设的寄存器,从而获取外设当前的状态。
外设状态是系统总状态的一部分

- 操作系统将获取到的各个外设状态作为系统总状态的一部分进行管理和维护。因此,系统总状态不仅包括CPU、内存、进程等内部状态,还包括了反映外部物理世界状态的外设状态。

- 操作系统根据当前状态做出响应 操作系统作为状态机,会根据当前的系统总状态(包括内部和外部),按照特定的逻辑规则,对CPU、内存、设备等资源做出相应的操作调度,从而引起状态的转移,进入新的状态。


# 计算机固件
我们reset CPU 后，我们需要一段程序帮助我们把cpu，硬件协调运作起来。它就是固件（firmware）。它通常被放在cpu被reset后的pc位置。

在CPU复位后,它会从一个预定义的内存地址(通常称为复位向量)处开始执行程序指令。这个复位向量地址存储了将要执行的第一条指令的地址。
这个储存在复位向量地址处的程序,通常被称为固件(firmware)或者BIOS(Basic Input/Output System)。它是存储在只读存储器(ROM)或者闪存中的一段代码。
固件/BIOS的作用是初始化计算机系统的硬件,执行自检(POST),探测和配置系统中的硬件设备等基本工作。
固件/BIOS还会进行一些基本的软件配置,比如确定操作系统的加载设备和位置。
完成上述基本工作后,固件/BIOS会根据设置的启动设备(如硬盘、光驱等),从设备上加载操作系统内核到内存中。（==最重要的功能==）
固件/BIOS最后会将系统控制权转移给已加载的操作系统内核,操作系统内核会接管计算机系统的进一步管理和运作。
在现代计算机系统中,固件/BIOS的功能还会被更先进的固件如UEFI(Unified Extensible Firmware Interface)所取代

## UEFI
有几个主要原因促使个人电脑从传统BIOS过渡到新的UEFI固件:

硬件复杂度增加 随着硬件不断发展,新的设备接口、新存储技术、高级图形等需要更复杂的固件来初始化和配置。传统BIOS变得无法满足需求。
引导过程限制 BIOS基于传统的老化MBR分区结构,对硬盘大小和引导方式有诸多限制。UEFI支持GUID分区表(GPT)、更大硬盘容量,以及更灵活的启动方式(如网络启动)。
安全性加强 UEFI内置了安全可信启动(Secure Boot)、数字签名验证等安全增强功能,防止恶意软件在启动阶段注入。
扩展性更强 UEFI通过EFI应用程序和驱动程序模型,可以在启动前加载诸多模块,为固件带来了更强的可扩展性。
更友好界面 UEFI提供基于UEFI Shell的现代化文本界面,或基于GOP的全彩色图形界面,比BIOS更直观友好。

## qemu
QEMU提供了计算机系统的完全模拟。
QEMU确实可以被视为在电脑主机系统上开启一个虚拟机,用于模拟其他计算机系统的硬件环境和运行其他操作系统。

具体来说,使用QEMU可以达到以下目的:

模拟其他硬件平台 QEMU可以精确模拟x86、ARM、RISC-V等不同的CPU指令集架构,以及各种外围设备和硬件环境,为开发和测试跨平台软件提供一致的运行环境。
运行其他操作系统 在模拟出的虚拟硬件环境中,可以安装和运行其他操作系统,如Windows、Linux、BSD等,而无需在物理机上重新安装。
探究系统工作原理 通过QEMU提供的调试和监控接口,开发人员可以深入研究操作系统内核、驱动程序等底层系统软件的行为,从而更好地理解系统工作原理。
安全隔离环境 QEMU虚拟化的客户机系统与主机系统是相互隔离的,可以在安全的沙箱环境中运行和测试不可信的代码。
总的来说,QEMU就相当于在您的电脑上再虚拟了一台"计算机",可以在其中自由地构建不同的软硬件环境,用于开发、测试、学习和研究不同的系统软硬件。这种虚拟化方式为计算机系统的可移植性和兼容性研究提供了极大的便利。

